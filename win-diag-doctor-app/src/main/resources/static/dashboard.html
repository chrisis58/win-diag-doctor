<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WinDiag Doctor - Monitor Center</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; background: #f0f2f5; padding: 20px; color: #333; }

        .header-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            background: white;
            padding: 15px 20px;
            border-radius: 8px;
            box-shadow: 0 1px 2px rgba(0,0,0,0.05);
        }

        h1 { margin: 0; font-size: 1.5em; color: #1f1f1f; }

        .action-group { display: flex; gap: 10px; }

        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            text-decoration: none;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }

        .btn:hover { opacity: 0.9; transform: translateY(-1px); }
        .btn:active { transform: translateY(0); }

        .btn-primary { background-color: #1890ff; color: white; }
        .btn-default { background-color: #f0f0f0; color: #333; border: 1px solid #d9d9d9; }
        .btn-outline { background-color: transparent; border: 1px solid #1890ff; color: #1890ff; }

        .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 20px; }

        .card {
            background: white; padding: 20px; border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08); cursor: pointer;
            transition: all 0.3s; border: 1px solid transparent;
        }
        .card:hover { transform: translateY(-5px); border-color: #1890ff; box-shadow: 0 4px 12px rgba(24, 144, 255, 0.2); }

        .card-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 10px; }
        .card h3 { margin: 0; font-size: 1.1em; }

        .status { display: inline-block; width: 10px; height: 10px; border-radius: 50%; margin-right: 6px; }
        .online { background-color: #52c41a; box-shadow: 0 0 4px #52c41a; }
        .offline { background-color: #f5222d; }

        .info-row { font-size: 0.85em; color: #666; margin-top: 5px; }
        .tag { background: #f5f5f5; padding: 2px 6px; border-radius: 4px; font-family: monospace; }

        .empty-state {
            grid-column: 1 / -1;
            text-align: center;
            padding: 40px;
            color: #999;
            background: white;
            border-radius: 8px;
            border: 2px dashed #eee;
        }

        .dropdown {
            position: relative;
            display: inline-block;
        }

        .dropdown-content {
            display: none;
            position: absolute;
            right: 0;
            background-color: #ffffff;
            min-width: 180px;
            box-shadow: 0 8px 16px 0 rgba(0,0,0,0.2);
            z-index: 1;
            border-radius: 4px;
            overflow: hidden;
        }

        .dropdown-content a {
            color: #333;
            padding: 12px 16px;
            text-decoration: none;
            display: block;
            font-size: 14px;
            transition: background-color 0.2s;
            text-align: left;
        }

        .dropdown-content a:hover {
            background-color: #f1f1f1;
            color: #1890ff;
        }

        .dropdown:hover .dropdown-content {
            display: block;
        }

        .dropdown .btn-main {
            border-bottom-left-radius: 0;
            border-bottom-right-radius: 0;
        }
    </style>
</head>
<body>

<div class="header-bar">
    <h1>ğŸ” å·²è¿æ¥çš„æ¢é’ˆ (Connected Probes)</h1>
    <div class="action-group">
        <button class="btn btn-default" onclick="loadProbes()">
            ğŸ”„ åˆ·æ–°åˆ—è¡¨
        </button>

        <div class="dropdown">
            <button class="btn btn-primary">
                â¬‡ï¸ ä¸‹è½½æ¢é’ˆ (Download) â–¼
            </button>
            <div class="dropdown-content">
                <a href="/api/probe/download?type=full" title="åŒ…å« JREï¼Œå¼€ç®±å³ç”¨ (æ¨è)">
                    ğŸ“¦ å®Œæ•´ç‰ˆ (Full)
                </a>
                <a href="/api/probe/download?type=lite" title="ä»… Jar åŒ…ï¼Œéœ€æœ¬åœ°æœ‰ Javaç¯å¢ƒ">
                    ğŸª¶ ç²¾ç®€ç‰ˆ (Lite)
                </a>
                <a href="/api/probe/download/properties" title="ä»…ä¸‹è½½é…ç½®æ–‡ä»¶ (ç”¨äºæ‰‹åŠ¨éƒ¨ç½²)">
                    âš™ï¸ ä»…é…ç½® (Config Only)
                </a>
            </div>
        </div>
    </div>
</div>

<div id="probe-list" class="grid">
</div>

<script>
    document.addEventListener('DOMContentLoaded', loadProbes);

    function loadProbes() {
        const container = document.getElementById('probe-list');

        if (container.children.length === 0) {
            container.innerHTML = '<div class="empty-state">æ­£åœ¨è·å–æ¢é’ˆçŠ¶æ€...</div>';
        }

        fetch('/api/probe/list')
            .then(res => {
                if (!res.ok) throw new Error("API Request Failed");
                return res.json();
            })
            .then(data => {
                container.innerHTML = '';

                if (!data || data.length === 0) {
                    container.innerHTML = `
                        <div class="empty-state">
                            <h3>æš‚æ— æ¢é’ˆè¿æ¥</h3>
                            <p>è¯·ç‚¹å‡»å³ä¸Šè§’ä¸‹è½½æ¢é’ˆï¼Œå¹¶åœ¨ç›®æ ‡æœºå™¨ä¸Šè¿è¡Œã€‚</p>
                        </div>`;
                    return;
                }

                data.forEach(probe => {
                    const card = document.createElement('div');
                    card.className = 'card';
                    const statusClass = (probe.status === 'ONLINE' || probe.status === 'CONNECTED') ? 'online' : 'offline';
                    const statusText = statusClass === 'online' ? 'åœ¨çº¿' : 'ç¦»çº¿';

                    card.innerHTML = `
                        <div class="card-header">
                            <h3>
                                <span class="status ${statusClass}"></span>
                                ${probe.hostname || 'Unknown Host'}
                            </h3>
                            <span style="font-size: 0.8em; color: ${statusClass === 'online' ? '#52c41a' : '#f5222d'}">
                                ${statusText}
                            </span>
                        </div>
                        <div class="info-row">ID: <span class="tag">${probe.id}</span></div>
                        <div class="info-row" style="margin-top: 10px; text-align: right; color: #1890ff; font-size: 0.9em;">
                            ç‚¹å‡»è¿›å…¥è¯Šæ–­ &rarr;
                        </div>
                    `;

                    card.onclick = () => {
                        enterChat(probe.id, probe.hostname);
                    };

                    container.appendChild(card);
                });
            })
            .catch(err => {
                console.error(err);
                container.innerHTML = `<div class="empty-state" style="color: red;">è·å–åˆ—è¡¨å¤±è´¥: ${err.message}</div>`;
            });
    }

    function enterChat(id, hostname) {
        if (!id) {
            alert("æ¢é’ˆ ID æ— æ•ˆï¼Œæ— æ³•è¿›å…¥è¯Šæ–­ã€‚");
            return;
        }

        const threadId = (window.crypto && window.crypto.randomUUID)
            ? window.crypto.randomUUID()
            : 'thread-' + Math.random().toString(36).substring(2, 15);

        const baseUrl = '/chatui/index.html';
        const params = new URLSearchParams({
            probeId: id,
            threadId: threadId,
        });

        window.location.href = `${baseUrl}?${params.toString()}`;
    }
</script>
</body>
</html>